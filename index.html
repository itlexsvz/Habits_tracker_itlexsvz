<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <meta charset="UTF-8">
    <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∏–≤—ã—á–µ–∫ by @itlexsvz</title>
    <link rel="manifest" href="manifest.json">
    
<style>
/* ========== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –° TELEGRAM –¢–ï–ú–û–ô ========== */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
}

html, body {
    width: 100% !important;
    height: 100% !important;
    overflow: auto !important;
    position: relative !important;
    -webkit-overflow-scrolling: touch !important;
    margin: 0 !important;
    padding: 0 !important;
    background: var(--tg-theme-bg-color, #f5f7fa) !important;
    color: var(--tg-theme-text-color, #333333) !important;
}

body {
    background: linear-gradient(135deg, var(--tg-theme-secondary-bg-color, #f5f7fa) 0%, var(--tg-theme-bg-color, #c3cfe2) 100%) !important;
    min-height: 100vh;
    overflow-x: hidden !important;
    overflow-y: auto !important;
}

.container {
    width: 100% !important;
    min-height: 100vh !important;
    max-width: 900px !important;
    margin: 0 auto !important;
    padding: 0 !important;
    background: var(--tg-theme-bg-color, white);
    border-radius: 0 !important;
    box-shadow: none !important;
    overflow: visible !important;
}

.content {
    padding: 20px !important;
    min-height: auto !important;
    height: auto !important;
    overflow: visible !important;
    padding-bottom: 80px !important; /* –î–ª—è –∫–Ω–æ–ø–∫–∏ Telegram */
}

/* ========== HEADER –° TELEGRAM –¢–ï–ú–û–ô ========== */
header {
    background: linear-gradient(to right, var(--tg-theme-button-color, #4CAF50), var(--tg-theme-link-color, #2E7D32)) !important;
    color: var(--tg-theme-button-text-color, white) !important;
    padding: 20px;
    text-align: center;
    border-radius: 0 !important;
    position: relative;
}

.user-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
    font-size: 14px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: none;
}

h1 {
    font-size: 24px;
    margin-bottom: 5px;
    color: var(--tg-theme-button-text-color, white) !important;
}

.subtitle {
    opacity: 0.9;
    font-size: 14px;
    color: var(--tg-theme-hint-color, rgba(255,255,255,0.9)) !important;
}

/* ========== TABS ========== */
.tabs {
    display: flex;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-bottom: 2px solid var(--tg-theme-section-bg-color, #e9ecef);
    flex-wrap: wrap;
    padding: 0 !important;
    margin: 0 !important;
}

.tab {
    flex: 1;
    padding: 16px 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background: transparent;
    color: var(--tg-theme-hint-color, #666);
    position: relative;
    border: none;
    font-size: 14px;
    overflow: hidden;
    min-width: 80px;
}

.tab::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) scaleX(0);
    width: 100%;
    height: 3px;
    background: var(--tg-theme-button-color, #4CAF50);
    transition: transform 0.3s ease;
    border-radius: 3px 3px 0 0;
}

.tab:hover {
    color: var(--tg-theme-link-color, #4CAF50);
    background: var(--tg-theme-section-bg-color, rgba(76, 175, 80, 0.04));
}

.tab.active {
    color: var(--tg-theme-link-color, #4CAF50);
    font-weight: 600;
}

.tab.active::before {
    transform: translateX(-50%) scaleX(1);
}

/* ========== SCREENS ========== */
.screen {
    display: none;
}

.screen.active {
    display: block;
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ========== BUTTONS –° TELEGRAM –¢–ï–ú–û–ô ========== */
.btn {
    padding: 12px 20px;
    background: var(--tg-theme-button-color, #4CAF50) !important;
    color: var(--tg-theme-button-text-color, white) !important;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    margin: 5px;
}

.btn:hover {
    background: var(--tg-theme-link-color, #3d8b40) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
}

.btn-secondary {
    background: var(--tg-theme-hint-color, #6c757d) !important;
}

.btn-secondary:hover {
    background: var(--tg-theme-text-color, #545b62) !important;
    box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
}

.btn-outline {
    background: var(--tg-theme-bg-color, white) !important;
    color: var(--tg-theme-button-color, #4CAF50) !important;
    border: 2px solid var(--tg-theme-button-color, #4CAF50);
}

.btn-outline:hover {
    background: var(--tg-theme-button-color, #4CAF50) !important;
    color: var(--tg-theme-button-text-color, white) !important;
}

.btn-share {
    background: var(--tg-theme-link-color, #2196F3) !important;
    color: var(--tg-theme-button-text-color, white) !important;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    margin: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
}

.btn-share:hover {
    background: var(--tg-theme-button-color, #0b7dda) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
}

/* Telegram Main Button —Å—Ç–∏–ª–∏ */
.telegram-main-btn {
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 1000 !important;
    width: 90% !important;
    max-width: 400px !important;
}

/* ========== COMMON ELEMENTS ========== */
.card {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 5px solid var(--tg-theme-button-color, #4CAF50);
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

input, select, textarea {
    padding: 12px 15px;
    border: 2px solid var(--tg-theme-section-bg-color, #e0e0e0);
    border-radius: 10px;
    font-size: 16px;
    transition: border 0.3s;
    flex: 1;
    background: var(--tg-theme-bg-color, white);
    color: var(--tg-theme-text-color, #333);
}

input:focus, select:focus, textarea:focus {
    border-color: var(--tg-theme-button-color, #4CAF50);
    outline: none;
}

/* ========== PLANNER SCREEN ========== */
.add-habit-form {
    margin-bottom: 25px;
}

.habit-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.habit-type-btn {
    padding: 10px 20px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border: 2px solid var(--tg-theme-section-bg-color, #e0e0e0);
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    flex: 1;
    text-align: center;
    min-width: 140px;
    color: var(--tg-theme-text-color, #333);
}

.habit-type-btn.active {
    background: var(--tg-theme-button-color, #4CAF50) !important;
    color: var(--tg-theme-button-text-color, white) !important;
    border-color: var(--tg-theme-button-color, #4CAF50);
}

.habit-type-btn:hover {
    border-color: var(--tg-theme-button-color, #4CAF50);
}

.habits-list {
    margin-bottom: 30px;
}

.habit-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 5px solid var(--tg-theme-button-color, #4CAF50);
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.habit-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 15px;
}

.habit-name {
    flex: 1;
    font-size: 16px;
    color: var(--tg-theme-text-color, #333);
}

.habit-type-icon {
    margin-left: 10px;
    font-size: 14px;
    color: var(--tg-theme-hint-color, #6c757d);
}

.delete-habit {
    background: #dc3545;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
}

.edit-habit {
    background: var(--tg-theme-link-color, #2196F3);
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
    transition: all 0.3s;
}

.edit-habit:hover {
    background: var(--tg-theme-button-color, #0b7dda);
    transform: scale(1.1);
}

/* ========== CALENDAR SCREEN ========== */
.month-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--tg-theme-section-bg-color, #f0f0f0);
}

.month-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--tg-theme-text-color, #2c3e50);
}

.month-nav {
    display: flex;
    gap: 10px;
}

.month-nav-btn {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--tg-theme-text-color, #333);
}

.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 25px;
}

.day-header {
    text-align: center;
    font-weight: 600;
    color: var(--tg-theme-hint-color, #6c757d);
    padding: 10px;
    font-size: 14px;
}

.day {
    aspect-ratio: 1;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    border: 2px solid transparent;
    min-height: 60px;
    color: var(--tg-theme-text-color, #333);
}

.day:hover {
    background: var(--tg-theme-section-bg-color, #e9ecef);
    transform: scale(1.05);
}

.day.active {
    background: var(--tg-theme-button-color, #4CAF50) !important;
    color: var(--tg-theme-button-text-color, white) !important;
}

.day-number {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
}

.day-habits {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 3px;
    max-width: 100%;
}

.habit-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.progress {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 5px;
}

/* ========== DAY SCREEN ========== */
.day-detail {
    text-align: center;
    margin-bottom: 25px;
}

.day-date {
    font-size: 20px;
    color: var(--tg-theme-text-color, #2c3e50);
    margin-bottom: 10px;
}

.habits-checklist {
    margin-top: 20px;
}

.habit-check {
    display: flex;
    align-items: center;
    padding: 16px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    color: var(--tg-theme-text-color, #333);
}

.habit-check:hover {
    background: var(--tg-theme-section-bg-color, #e9ecef);
}

.habit-check.completed {
    background: #d4edda;
    border-left: 5px solid #28a745;
}

.habit-value-input {
    width: 80px;
    padding: 8px 10px;
    border: 2px solid var(--tg-theme-section-bg-color, #e0e0e0);
    border-radius: 6px;
    font-size: 14px;
    margin-left: 10px;
    text-align: center;
    background: var(--tg-theme-bg-color, white);
    color: var(--tg-theme-text-color, #333);
}

.habit-value-input:focus {
    border-color: var(--tg-theme-button-color, #4CAF50);
    outline: none;
}

.checkmark {
    width: 24px;
    height: 24px;
    border: 2px solid var(--tg-theme-hint-color, #6c757d);
    border-radius: 5px;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.habit-check.completed .checkmark {
    background: #28a745;
    border-color: #28a745;
    color: white;
}

.share-section {
    margin-top: 30px;
    padding: 20px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 15px;
    text-align: center;
}

.share-preview {
    background: var(--tg-theme-bg-color, white);
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    text-align: left;
    font-family: 'Courier New', monospace;
    white-space: pre-line;
    max-height: 200px;
    overflow-y: auto;
    border: 2px dashed var(--tg-theme-section-bg-color, #e0e0e0);
    color: var(--tg-theme-text-color, #333);
}

.share-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

/* ========== STATISTICS SCREEN ========== */
.statistics-container {
    margin-bottom: 25px;
}

.month-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 10px;
}

.month-selector label {
    font-weight: 600;
    color: var(--tg-theme-text-color, #2c3e50);
}

.month-selector select {
    max-width: 200px;
    background: var(--tg-theme-bg-color, white);
    color: var(--tg-theme-text-color, #333);
}

.chart-container {
    background: var(--tg-theme-bg-color, white);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--tg-theme-text-color, #2c3e50);
    margin-bottom: 20px;
    text-align: center;
}

.chart {
    width: 100%;
    height: 300px;
    position: relative;
    margin-bottom: 10px;
}

.x-axis {
    display: flex;
    justify-content: space-between;
    margin: 0;
    padding-top: 10px;
    border-top: 2px solid var(--tg-theme-section-bg-color, #e0e0e0);
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background: var(--tg-theme-bg-color, white);
    z-index: 10;
}

.x-label {
    font-size: 11px;
    color: var(--tg-theme-hint-color, #6c757d);
    text-align: center;
    flex: 1;
    min-width: 0;
    padding: 0 2px;
    font-weight: 500;
}

.chart-bars {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: calc(100% - 40px);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    padding-bottom: 30px;
}

.bar-container {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    margin: 0 1px;
    position: relative;
}

.bar {
    width: 60%;
    background: linear-gradient(to top, var(--tg-theme-button-color, #4CAF50), var(--tg-theme-link-color, #8BC34A));
    border-radius: 4px 4px 0 0;
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
    max-width: 30px;
    min-width: 15px;
}

.bar:hover {
    opacity: 0.8;
    transform: scaleX(1.1);
}

.bar-value {
    position: absolute;
    top: -25px;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--tg-theme-button-color, #4CAF50);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.x-axis-title {
    text-align: center;
    font-size: 12px;
    color: var(--tg-theme-hint-color, #666);
    margin-top: 5px;
    font-weight: 500;
}

.stats-summary {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 15px;
    padding: 20px;
    margin-top: 25px;
}

.stats-summary h3 {
    margin-bottom: 15px;
    color: var(--tg-theme-text-color, #2c3e50);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.stat-item {
    background: var(--tg-theme-bg-color, white);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--tg-theme-button-color, #4CAF50);
}

.stat-label {
    font-size: 14px;
    color: var(--tg-theme-hint-color, #6c757d);
    margin-top: 5px;
}

/* ========== TELEGRAM CLOUD EXPORT/IMPORT ========== */
.telegram-cloud-section {
    margin-top: 30px;
    padding: 20px;
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border-radius: 15px;
    text-align: center;
}

.cloud-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
}

.cloud-btn {
    background: var(--tg-theme-button-color, #4CAF50);
    color: var(--tg-theme-button-text-color, white);
}

.cloud-btn-backup {
    background: var(--tg-theme-link-color, #2196F3);
}

.cloud-btn-restore {
    background: var(--tg-theme-link-color, #9C27B0);
}

.cloud-info {
    margin-top: 15px;
    font-size: 12px;
    color: var(--tg-theme-hint-color, #6c757d);
    line-height: 1.4;
}

/* ========== EMPTY STATES ========== */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--tg-theme-hint-color, #6c757d);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* ========== FOOTER ========== */
footer {
    text-align: center;
    padding: 20px;
    color: var(--tg-theme-hint-color, #6c757d);
    font-size: 14px;
    border-top: 1px solid var(--tg-theme-section-bg-color, #e9ecef);
    margin-top: 20px;
}

/* ========== TELEGRAM HAPTIC FEEDBACK ========== */
.haptic {
    cursor: pointer;
}

.haptic:active {
    animation: hapticPress 0.2s;
}

@keyframes hapticPress {
    0% { transform: scale(1); }
    50% { transform: scale(0.95); }
    100% { transform: scale(1); }
}

/* ========== MODALS ========== */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s;
}

.modal {
    background: var(--tg-theme-bg-color, white);
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    color: var(--tg-theme-text-color, #333);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--tg-theme-text-color, #2c3e50);
}

.close-modal {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--tg-theme-text-color, #333);
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* ========== FIXES FOR MOBILE ========== */
@supports (-webkit-touch-callout: none) {
    html, body {
        height: -webkit-fill-available !important;
    }
    
    .container {
        min-height: -webkit-fill-available !important;
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .content {
        padding: 15px !important;
    }
    
    .chart {
        height: 250px;
    }
    
    .x-label {
        font-size: 10px;
    }
    
    .modal {
        width: 95%;
        padding: 20px;
    }
    
    .chart-bars {
        padding-bottom: 40px;
    }
    
    .bar {
        width: 50%;
        max-width: 20px;
    }
    
    .bar-value {
        font-size: 9px;
    }
}

@media (max-width: 600px) {
    .tabs {
        flex-direction: row;
        overflow-x: auto;
    }
    
    .tab {
        min-width: 100px;
        padding: 12px 8px;
        font-size: 13px;
    }
    
    .month-grid {
        gap: 5px;
    }
    
    .day {
        padding: 5px;
        min-height: 45px;
    }
    
    .day-number {
        font-size: 14px;
    }
    
    .habit-dot {
        width: 6px;
        height: 6px;
    }
    
    .input-group {
        flex-direction: column;
    }
    
    .btn {
        padding: 10px 15px;
        font-size: 14px;
    }
    
    .btn-share {
        padding: 10px 15px;
        font-size: 14px;
    }
    
    .habit-type-selector {
        flex-direction: column;
    }
    
    .habit-type-btn {
        min-width: 100%;
    }
    
    .chart {
        height: 220px;
    }
    
    .bar-value {
        font-size: 8px;
        top: -20px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .habit-item {
        padding: 12px;
    }
    
    .delete-habit, .edit-habit {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
    
    .x-label {
        font-size: 8px;
        padding: 0 1px;
    }
    
    .bar {
        width: 40%;
        max-width: 15px;
    }
}

@media (max-width: 360px) {
    .day {
        min-height: 40px !important;
    }
    
    .day-number {
        font-size: 12px !important;
    }
    
    .habit-dot {
        width: 5px !important;
        height: 5px !important;
    }
    
    .chart {
        height: 200px;
    }
    
    .bar {
        width: 35%;
        max-width: 12px;
    }
    
    .bar-value {
        font-size: 7px;
    }
}
</style>

</head>
<body>
    <div class="container">
        <header>
            <h1>üìã –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∏–≤—ã—á–µ–∫</h1>
            <div class="subtitle">–í Telegram Mini App</div>
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active haptic" onclick="showScreen('planner')">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</div>
            <div class="tab haptic" onclick="showScreen('calendar')">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
            <div class="tab haptic" onclick="showScreen('day')">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="tab haptic" onclick="showScreen('statistics')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
        
        <div class="content">
            <!-- –≠–∫—Ä–∞–Ω 1: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∏–≤—ã—á–µ–∫ -->
            <div id="planner-screen" class="screen active">
                <h2>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏</h2>
                <p style="margin: 10px 0 20px; color: var(--tg-theme-hint-color, #6c757d);">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å</p>
                
                <div class="add-habit-form">
                    <div class="habit-type-selector">
                        <div class="habit-type-btn active haptic" id="habitTypeCheckbox" onclick="selectHabitType('checkbox')">
                            ‚úÖ –ß–µ–∫–±–æ–∫—Å (–¥–∞/–Ω–µ—Ç)
                        </div>
                        <div class="habit-type-btn haptic" id="habitTypeNumber" onclick="selectHabitType('number')">
                            üî¢ –ß–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="habitInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏—Ç—å 2 –ª–∏—Ç—Ä–∞ –≤–æ–¥—ã">
                        <input type="text" id="habitUnit" placeholder="–µ–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ª–∏—Ç—Ä—ã, —á–∞—Å—ã, –∫–≥)" style="display: none; max-width: 150px;">
                        <button class="btn haptic" onclick="addHabit()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="habits-list" id="habitsList">
                    <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn haptic" onclick="showScreen('calendar')">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é</button>
                    <button class="btn btn-secondary haptic" onclick="showScreen('statistics')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Üí</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 2: –ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Å—è—Ü–∞ -->
            <div id="calendar-screen" class="screen">
                <div class="month-header">
                    <div class="month-title" id="monthTitle">–Ø–Ω–≤–∞—Ä—å 2025</div>
                    <div class="month-nav">
                        <button class="month-nav-btn haptic" onclick="changeMonth(-1)">‚Üê</button>
                        <button class="month-nav-btn haptic" onclick="changeMonth(1)">‚Üí</button>
                    </div>
                </div>
                
                <div class="month-grid" id="monthGrid">
                    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary haptic" onclick="showScreen('planner')">‚Üê –ù–∞–∑–∞–¥</button>
                    <button class="btn haptic" onclick="showScreen('day')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è ‚Üí</button>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 3: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
            <div id="day-screen" class="screen">
                <div class="day-detail">
                    <div class="day-date" id="todayDate">–°–µ–≥–æ–¥–Ω—è, 1 —è–Ω–≤–∞—Ä—è</div>
                    <div style="color: var(--tg-theme-hint-color, #6c757d);">–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="habits-checklist" id="todayHabits">
                    <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-secondary haptic" onclick="showScreen('calendar')">‚Üê –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                    <button class="btn haptic" onclick="saveToday()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <div class="share-section" id="shareSection" style="display: none;">
                    <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º</h3>
                    <div class="share-preview" id="sharePreview"></div>
                    <div class="share-buttons">
                        <button class="btn-share haptic" onclick="shareToTelegramChat()">
                            üí¨ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ —á–∞—Ç
                        </button>
                        <button class="btn-share haptic" onclick="copyToClipboard()" style="background: var(--tg-theme-secondary-bg-color, #6c757d) !important;">
                            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω 4: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="statistics-screen" class="screen">
                <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫</h2>
                <p style="margin: 10px 0 20px; color: var(--tg-theme-hint-color, #6c757d);">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                
                <div class="statistics-container">
                    <div class="month-selector">
                        <label for="statsMonth">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü:</label>
                        <select id="statsMonth" onchange="updateStatisticsChart()">
                            <!-- –ú–µ—Å—è—Ü—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </select>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">–ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫ (%)</div>
                        <div class="chart" id="progressChart">
                            <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
                        </div>
                        <div class="x-axis-title">–î–Ω–∏ –º–µ—Å—è—Ü–∞</div>
                    </div>
                    
                    <div class="stats-summary">
                        <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div class="stats-grid" id="statsSummary">
                            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                    
                    <!-- Telegram Cloud Storage -->
                    <div class="telegram-cloud-section">
                        <h3>Telegram Cloud Storage</h3>
                        <p style="margin: 10px 0 20px; color: var(--tg-theme-hint-color, #6c757d);">
                            –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ Telegram
                        </p>
                        
                        <div class="cloud-buttons">
                            <button class="btn cloud-btn haptic" onclick="forceSaveToCloud()">
                                üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button class="btn cloud-btn-backup haptic" onclick="createBackup()">
                                üì¶ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                            </button>
                            <button class="btn cloud-btn-restore haptic" onclick="restoreFromCloud()">
                                üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
                            </button>
                        </div>
                        
                        <div class="cloud-info">
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="cloudStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></p>
                            <p><em>–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏</em></p>
                        </div>
                    </div>
                    
                    <div class="empty-state" id="statsEmpty" style="display: none;">
                        <div class="empty-icon">üìä</div>
                        <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-secondary haptic" onclick="showScreen('day')">‚Üê –°–µ–≥–æ–¥–Ω—è</button>
                    <button class="btn haptic" onclick="showScreen('planner')">–í –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ ‚Üí</button>
                </div>
            </div>
        </div>
        
        <footer>
            <div>Telegram Mini App ‚Ä¢ –î–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ Telegram ‚Ä¢ <span id="lastSync">–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</span></div>
            <div style="font-size: 12px; margin-top: 5px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
        </footer>
        
        <!-- Telegram Main Button Container -->
        <div id="telegramButtonContainer" class="telegram-main-btn"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏ -->
    <div id="editHabitModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</div>
                <button class="close-modal haptic" onclick="closeEditModal()">√ó</button>
            </div>
            
            <div class="habit-type-selector" id="editHabitTypeSelector">
                <div class="habit-type-btn active haptic" onclick="selectEditHabitType('checkbox')">
                    ‚úÖ –ß–µ–∫–±–æ–∫—Å (–¥–∞/–Ω–µ—Ç)
                </div>
                <div class="habit-type-btn haptic" onclick="selectEditHabitType('number')">
                    üî¢ –ß–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                </div>
            </div>
            
            <div class="input-group" style="flex-direction: column; margin-top: 15px;">
                <input type="text" id="editHabitName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏">
                <input type="text" id="editHabitUnit" placeholder="–µ–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ª–∏—Ç—Ä—ã, —á–∞—Å—ã, –∫–≥)" style="display: none; margin-top: 10px;">
            </div>
            
            <div class="modal-actions">
                <button class="btn haptic" onclick="saveEditedHabit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary haptic" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="cloudBackupModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚òÅÔ∏è –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                <button class="close-modal haptic" onclick="closeCloudModal()">√ó</button>
            </div>
            
            <div style="margin: 20px 0;">
                <div id="backupList">
                    <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn haptic" onclick="createNewBackup()">
                        üì¶ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                    </button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary haptic" onclick="closeCloudModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // ========== TELEGRAM WEBAPP –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        let tg = null;
        let isTelegramWebApp = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –≤ Telegram WebApp
        if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            isTelegramWebApp = true;
            console.log('–ó–∞–ø—É—â–µ–Ω–æ –≤ Telegram WebApp');
        } else {
            console.log('–ó–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram WebApp (–±—Ä–∞—É–∑–µ—Ä)');
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            tg = {
                initDataUnsafe: {
                    user: {
                        first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                        last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        username: 'test_user',
                        language_code: 'ru'
                    }
                },
                CloudStorage: {
                    setItem: (key, value, callback) => {
                        localStorage.setItem(key, value);
                        if (callback) callback(null, true);
                    },
                    getItem: (key, callback) => {
                        const value = localStorage.getItem(key);
                        if (callback) callback(null, value);
                    },
                    getItems: (keys, callback) => {
                        const result = {};
                        keys.forEach(key => {
                            result[key] = localStorage.getItem(key);
                        });
                        if (callback) callback(null, result);
                    }
                },
                expand: () => console.log('–†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω'),
                ready: () => console.log('WebApp –≥–æ—Ç–æ–≤'),
                MainButton: {
                    setText: (text) => console.log('–ö–Ω–æ–ø–∫–∞:', text),
                    show: () => console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É'),
                    hide: () => console.log('–°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É'),
                    onClick: (fn) => console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'),
                    offClick: (fn) => console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —É–¥–∞–ª–µ–Ω')
                },
                showAlert: (msg) => alert(msg),
                showConfirm: (msg, callback) => {
                    const result = confirm(msg);
                    if (callback) callback(result);
                },
                HapticFeedback: {
                    impactOccurred: (style) => console.log('–í–∏–±—Ä–∞—Ü–∏—è:', style)
                }
            };
        }
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedHabitType = 'checkbox';
        let editHabitType = 'checkbox';
        let editingHabitId = null;
        
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let appData = {
            habits: [],
            plan: {},
            settings: {
                theme: 'light',
                notifications: true
            },
            metadata: {
                created: new Date().toISOString(),
                version: '2.0',
                telegramUserId: null
            }
        };
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫
        const habitColors = [
            '#4CAF50', '#2196F3', '#FF9800', '#E91E63', 
            '#9C27B0', '#00BCD4', '#FF5722', '#795548',
            '#3F51B5', '#009688', '#FFEB3B', '#607D8B'
        ];
        
        // –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEBAPP ==========
        function initTelegramWebApp() {
            if (!isTelegramWebApp) return;
            
            // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.expand();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#4CAF50');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#4CAF50');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f1f1');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                document.getElementById('userName').textContent = 
                    user.first_name + (user.last_name ? ' ' + user.last_name : '');
                
                if (user.photo_url) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.src = user.photo_url;
                    avatar.style.display = 'block';
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                appData.metadata.telegramUserId = user.id;
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram
            setupTelegramMainButton();
            
            // –°–æ–æ–±—â–∞–µ–º Telegram —á—Ç–æ WebApp –≥–æ—Ç–æ–≤
            tg.ready();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram Cloud
            loadFromTelegramCloud();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            updateCloudStatus();
        }
        
        // ========== –ù–ê–°–¢–†–û–ô–ö–ê –ö–ù–û–ü–ö–ò TELEGRAM ==========
        function setupTelegramMainButton() {
            if (!isTelegramWebApp) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
            const buttonContainer = document.getElementById('telegramButtonContainer');
            buttonContainer.innerHTML = '';
            
            const saveButton = document.createElement('button');
            saveButton.className = 'btn';
            saveButton.style.cssText = `
                width: 100%;
                padding: 15px;
                font-size: 16px;
                font-weight: 600;
                background: var(--tg-theme-button-color, #4CAF50);
                color: var(--tg-theme-button-text-color, white);
                border: none;
                border-radius: 10px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            `;
            saveButton.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ Telegram';
            saveButton.onclick = saveToTelegramCloud;
            
            buttonContainer.appendChild(saveButton);
        }
        
        // ========== TELEGRAM CLOUD STORAGE ==========
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Telegram Cloud
        function saveToTelegramCloud() {
            if (!isTelegramWebApp) {
                saveToLocalStorage();
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ –≤ Telegram)');
                return;
            }
            
            const data = {
                habits: appData.habits,
                plan: appData.plan,
                settings: appData.settings,
                metadata: {
                    ...appData.metadata,
                    lastSync: new Date().toISOString()
                }
            };
            
            const dataString = JSON.stringify(data);
            
            tg.CloudStorage.setItem('habits_data', dataString, (error) => {
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ:', error);
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ');
                    
                    // –ü—Ä–æ–±—É–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    saveToLocalStorage();
                } else {
                    console.log('–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Telegram Cloud');
                    showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ Telegram');
                    updateCloudStatus(true);
                    
                    // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
                    const timestamp = new Date().getTime();
                    tg.CloudStorage.setItem(`backup_${timestamp}`, dataString, () => {
                        console.log('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞');
                    });
                }
            });
            
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Telegram Cloud
        function loadFromTelegramCloud() {
            if (!isTelegramWebApp) {
                loadFromLocalStorage();
                return;
            }
            
            tg.CloudStorage.getItem('habits_data', (error, value) => {
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞:', error);
                    loadFromLocalStorage();
                } else if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        appData.habits = parsed.habits || [];
                        appData.plan = parsed.plan || {};
                        appData.settings = parsed.settings || appData.settings;
                        appData.metadata = { ...appData.metadata, ...parsed.metadata };
                        
                        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Telegram Cloud');
                        showNotification('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞ Telegram');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        renderHabits();
                        generateCalendar();
                        updateStatisticsChart();
                        updateCloudStatus(true);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                        checkDataFreshness();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
                        loadFromLocalStorage();
                    }
                } else {
                    console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ');
                    loadFromLocalStorage();
                }
            });
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function forceSaveToCloud() {
            saveToTelegramCloud();
            showNotification('üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        function createBackup() {
            if (!isTelegramWebApp) {
                showNotification('–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ Telegram');
                return;
            }
            
            const data = {
                habits: appData.habits,
                plan: appData.plan,
                settings: appData.settings,
                metadata: {
                    ...appData.metadata,
                    backupDate: new Date().toISOString(),
                    backupType: 'manual'
                }
            };
            
            const timestamp = new Date().getTime();
            const humanDate = new Date().toLocaleDateString('ru-RU');
            
            tg.CloudStorage.setItem(`backup_manual_${timestamp}`, JSON.stringify(data), (error) => {
                if (error) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏');
                } else {
                    showNotification(`‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ (${humanDate})`);
                    
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('heavy');
                    }
                }
            });
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –æ–±–ª–∞–∫–∞
        function restoreFromCloud() {
            if (!isTelegramWebApp) {
                showNotification('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Telegram');
                return;
            }
            
            tg.showConfirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.', (confirmed) => {
                if (confirmed) {
                    loadFromTelegramCloud();
                    
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('rigid');
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function updateCloudStatus(success) {
            const statusElement = document.getElementById('cloudStatus');
            const lastSyncElement = document.getElementById('lastSync');
            
            if (success) {
                statusElement.textContent = '‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                statusElement.style.color = '#4CAF50';
                lastSyncElement.textContent = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                statusElement.textContent = '‚ùå –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                statusElement.style.color = '#f44336';
                lastSyncElement.textContent = '–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
        function checkDataFreshness() {
            if (!appData.metadata.lastSync) return;
            
            const lastSync = new Date(appData.metadata.lastSync);
            const now = new Date();
            const diffHours = (now - lastSync) / (1000 * 60 * 60);
            
            if (diffHours > 24) {
                showNotification('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –±–æ–ª–µ–µ —Å—É—Ç–æ–∫', 'warning');
            }
        }
        
        // ========== –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï (–ó–ê–ü–ê–°–ù–û–ô –í–ê–†–ò–ê–ù–¢) ==========
        function saveToLocalStorage() {
            try {
                localStorage.setItem('habits_data', JSON.stringify({
                    habits: appData.habits,
                    plan: appData.plan,
                    settings: appData.settings,
                    metadata: {
                        ...appData.metadata,
                        lastLocalSave: new Date().toISOString()
                    }
                }));
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('habits_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    appData.habits = parsed.habits || [];
                    appData.plan = parsed.plan || {};
                    appData.settings = parsed.settings || appData.settings;
                    appData.metadata = { ...appData.metadata, ...parsed.metadata };
                    
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage');
                    renderHabits();
                    generateCalendar();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
            }
        }
        
        // ========== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
            initTelegramWebApp();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (!isTelegramWebApp) {
                loadFromLocalStorage();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            renderHabits();
            updateStats();
            showScreen('planner');
            generateCalendar();
            loadToday();
            initializeStatistics();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            setupAutoSave();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫
            document.getElementById('habitInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addHabit();
            });
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        function setupAutoSave() {
            let saveTimeout;
            
            function scheduleSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    if (isTelegramWebApp) {
                        saveToTelegramCloud();
                    } else {
                        saveToLocalStorage();
                    }
                }, 2000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            }
            
            // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ
            const originalAddHabit = addHabit;
            addHabit = function() {
                originalAddHabit.apply(this, arguments);
                scheduleSave();
            };
            
            const originalToggleHabit = toggleHabit;
            toggleHabit = function() {
                originalToggleHabit.apply(this, arguments);
                scheduleSave();
            };
            
            const originalUpdateNumberHabit = updateNumberHabit;
            updateNumberHabit = function() {
                originalUpdateNumberHabit.apply(this, arguments);
                scheduleSave();
            };
            
            const originalDeleteHabit = deleteHabit;
            deleteHabit = function() {
                originalDeleteHabit.apply(this, arguments);
                scheduleSave();
            };
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        
        function showNotification(message, type = 'info') {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram API –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
            if (isTelegramWebApp && tg && tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
            
            // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –æ—à–∏–±–æ–∫
            if (type === 'error' && tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –≤–∏–±—Ä–∞—Ü–∏–µ–π
        function showAlertWithHaptic(message) {
            if (tg && tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screenId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
            const targetScreen = document.getElementById(screenId + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.tab[onclick*="${screenId}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —ç–∫—Ä–∞–Ω–∞
            if (screenId === 'calendar') {
                generateCalendar();
            } else if (screenId === 'day') {
                loadToday();
                generateSharePreview();
            } else if (screenId === 'planner') {
                updateStats();
            } else if (screenId === 'statistics') {
                updateStatisticsChart();
            }
            
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('soft');
            }
        }
        
        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–∏–≤—ã—á–∫–∏
        function selectHabitType(type) {
            selectedHabitType = type;
            document.getElementById('habitTypeCheckbox').classList.toggle('active', type === 'checkbox');
            document.getElementById('habitTypeNumber').classList.toggle('active', type === 'number');
            
            const unitInput = document.getElementById('habitUnit');
            unitInput.style.display = type === 'number' ? 'block' : 'none';
            
            const mainInput = document.getElementById('habitInput');
            if (type === 'number') {
                mainInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: –í—ã–ø–∏—Ç—å –≤–æ–¥—ã";
                unitInput.placeholder = "–µ–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ª–∏—Ç—Ä—ã, —á–∞—Å—ã, –∫–º)";
            } else {
                mainInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É";
                unitInput.value = "";
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
        function addHabit() {
            const input = document.getElementById('habitInput');
            const unitInput = document.getElementById('habitUnit');
            const name = input.value.trim();
            const unit = unitInput.value.trim();
            
            if (name === '') {
                showAlertWithHaptic('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏');
                return;
            }
            
            if (selectedHabitType === 'number' && unit === '') {
                showAlertWithHaptic('–í–≤–µ–¥–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏');
                return;
            }
            
            const newHabit = {
                id: Date.now(),
                name: name,
                type: selectedHabitType,
                color: habitColors[appData.habits.length % habitColors.length],
                unit: selectedHabitType === 'number' ? unit : null,
                created: new Date().toISOString()
            };
            
            appData.habits.push(newHabit);
            input.value = '';
            unitInput.value = '';
            
            selectHabitType('checkbox');
            renderHabits();
            updateStats();
            
            if (appData.habits.length === 1) {
                generateCalendar();
            }
            
            showNotification('‚úÖ –ü—Ä–∏–≤—ã—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–≤—ã—á–µ–∫
        function renderHabits() {
            const habitsList = document.getElementById('habitsList');
            
            if (appData.habits.length === 0) {
                habitsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ûï</div>
                        <h3>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É –≤—ã—à–µ</p>
                    </div>
                `;
                return;
            }
            
            habitsList.innerHTML = appData.habits.map(habit => {
                const typeIcon = habit.type === 'number' ? 'üî¢' : '‚úÖ';
                const unitText = habit.unit ? ` (${habit.unit})` : '';
                
                return `
                    <div class="habit-item">
                        <div class="habit-color" style="background: ${habit.color}"></div>
                        <div class="habit-name">
                            ${habit.name}${unitText}
                            <span class="habit-type-icon">${typeIcon}</span>
                        </div>
                        <button class="edit-habit haptic" onclick="editHabit(${habit.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button class="delete-habit haptic" onclick="deleteHabit(${habit.id})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                `;
            }).join('');
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
        function deleteHabit(id) {
            if (tg && tg.showConfirm) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–∏–≤—ã—á–∫—É?', (confirmed) => {
                    if (confirmed) {
                        performDelete(id);
                    }
                });
            } else {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–∏–≤—ã—á–∫—É?')) {
                    performDelete(id);
                }
            }
        }
        
        function performDelete(id) {
            appData.habits = appData.habits.filter(habit => habit.id !== id);
            renderHabits();
            updateStats();
            generateCalendar();
            showNotification('üóëÔ∏è –ü—Ä–∏–≤—ã—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function generateCalendar() {
            const monthGrid = document.getElementById('monthGrid');
            const monthTitle = document.getElementById('monthTitle');
            
            monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            let calendarHTML = '';
            
            dayNames.forEach(day => {
                calendarHTML += `<div class="day-header">${day}</div>`;
            });
            
            let firstDayIndex = firstDay.getDay();
            firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
            
            for (let i = 0; i < firstDayIndex; i++) {
                calendarHTML += `<div class="day" style="visibility: hidden;"></div>`;
            }
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = `${currentYear}-${currentMonth}-${day}`;
                const isToday = isCurrentMonth && day === today.getDate();
                
                const dayData = appData.plan[dayKey] || {};
                
                let completedCount = 0;
                appData.habits.forEach(habit => {
                    const habitData = dayData[habit.id];
                    if (habit.type === 'checkbox' && habitData === true) {
                        completedCount++;
                    } else if (habit.type === 'number' && habitData && habitData.value > 0) {
                        completedCount++;
                    }
                });
                
                let habitDots = '';
                appData.habits.forEach((habit, index) => {
                    if (index < 8) {
                        const habitData = dayData[habit.id];
                        let isCompleted = false;
                        
                        if (habit.type === 'checkbox' && habitData === true) {
                            isCompleted = true;
                        } else if (habit.type === 'number' && habitData && habitData.value > 0) {
                            isCompleted = true;
                        }
                        
                        habitDots += `<div class="habit-dot" style="background: ${habit.color}; opacity: ${isCompleted ? '1' : '0.3'}"></div>`;
                    }
                });
                
                const progressPercent = appData.habits.length > 0 
                    ? Math.round((completedCount / appData.habits.length) * 100) 
                    : 0;
                
                calendarHTML += `
                    <div class="day ${isToday ? 'active' : ''} haptic" onclick="viewDay(${day})">
                        <div class="day-number">${day}</div>
                        <div class="day-habits">${habitDots}</div>
                        ${appData.habits.length > 0 ? `<div class="progress">${progressPercent}%</div>` : ''}
                    </div>
                `;
            }
            
            monthGrid.innerHTML = calendarHTML;
        }
        
        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω—è
        function viewDay(day) {
            const selectedDate = new Date(currentYear, currentMonth, day);
            currentDate = selectedDate;
            showScreen('day');
            loadToday();
            generateSharePreview();
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞
        function changeMonth(direction) {
            currentMonth += direction;
            
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            generateCalendar();
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
        function loadToday() {
            const todayHabits = document.getElementById('todayHabits');
            const todayDate = document.getElementById('todayDate');
            
            const day = currentDate.getDate();
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            const monthNamesRu = [
                '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
            ];
            
            const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
            const dayOfWeek = dayNames[currentDate.getDay()];
            
            todayDate.textContent = `${day} ${monthNamesRu[month]} ${year}, ${dayOfWeek}`;
            
            const dayKey = `${year}-${month}-${day}`;
            const dayData = appData.plan[dayKey] || {};
            
            todayHabits.innerHTML = appData.habits.map(habit => {
                const habitData = dayData[habit.id];
                
                if (habit.type === 'checkbox') {
                    const isCompleted = habitData === true;
                    
                    return `
                        <div class="habit-check ${isCompleted ? 'completed' : ''} haptic" onclick="toggleHabit(${habit.id})">
                            <div class="checkmark">${isCompleted ? '‚úì' : ''}</div>
                            <div class="habit-name">${habit.name}</div>
                        </div>
                    `;
                } else if (habit.type === 'number') {
                    const currentValue = habitData ? habitData.value : 0;
                    const isCompleted = currentValue > 0;
                    
                    return `
                        <div class="habit-check ${isCompleted ? 'completed' : ''}">
                            <div class="checkmark">${isCompleted ? '‚úì' : ''}</div>
                            <div class="habit-name">${habit.name}</div>
                            <input type="number" 
                                   class="habit-value-input" 
                                   value="${currentValue}" 
                                   placeholder="${habit.unit}"
                                   min="0"
                                   step="0.1"
                                   onchange="updateNumberHabit(${habit.id}, this.value)">
                        </div>
                    `;
                }
            }).join('');
            
            if (appData.habits.length === 0) {
                todayHabits.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <h3>–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è</h3>
                        <p>–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ</p>
                    </div>
                `;
            }
            
            const shareSection = document.getElementById('shareSection');
            shareSection.style.display = appData.habits.length > 0 ? 'block' : 'none';
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
        function toggleHabit(habitId) {
            const day = currentDate.getDate();
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const dayKey = `${year}-${month}-${day}`;
            
            if (!appData.plan[dayKey]) {
                appData.plan[dayKey] = {};
            }
            
            appData.plan[dayKey][habitId] = !appData.plan[dayKey][habitId];
            
            loadToday();
            generateCalendar();
            updateStats();
            generateSharePreview();
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏
        function updateNumberHabit(habitId, value) {
            const day = currentDate.getDate();
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const dayKey = `${year}-${month}-${day}`;
            
            if (!appData.plan[dayKey]) {
                appData.plan[dayKey] = {};
            }
            
            const numValue = parseFloat(value) || 0;
            appData.plan[dayKey][habitId] = { value: numValue };
            
            loadToday();
            generateCalendar();
            updateStats();
            generateSharePreview();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
        function saveToday() {
            if (isTelegramWebApp) {
                saveToTelegramCloud();
            } else {
                saveToLocalStorage();
            }
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            showScreen('calendar');
        }
        
        // ========== TELEGRAM –®–ê–†–ò–ù–ì ==========
        
        function shareToTelegramChat() {
            const sharePreview = document.getElementById('sharePreview');
            const text = sharePreview.textContent;
            
            if (isTelegramWebApp && tg) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞
                const day = currentDate.getDate();
                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                
                const message = `üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º –∑–∞ ${day}.${month + 1}.${year}:\n\n${text}`;
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram WebApp API –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                if (typeof tg.shareToChat === 'function') {
                    tg.shareToChat({
                        text: message
                    }, (success) => {
                        if (success) {
                            showNotification('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç');
                        } else {
                            // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
                            useFallbackSharing(message);
                        }
                    });
                } else {
                    // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
                    useFallbackSharing(message);
                }
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            } else {
                // –í–Ω–µ Telegram - –∏—Å–ø–æ–ª—å–∑—É–µ–º Web Share API –∏–ª–∏ –∫–æ–ø–∏—Ä—É–µ–º
                useWebShareAPI(text);
            }
        }
        
        function useFallbackSharing(message) {
            // –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É share
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(message)}`;
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
        }
        
        function useWebShareAPI(text) {
            if (navigator.share) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Web Share API –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                navigator.share({
                    title: '–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º',
                    text: text,
                    url: window.location.href
                }).then(() => {
                    showNotification('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                }).catch((error) => {
                    console.log('–û—à–∏–±–∫–∞ —à–∞—Ä–∏–Ω–≥–∞:', error);
                    copyToClipboard();
                });
            } else {
                // Fallback –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
                copyToClipboard();
            }
        }
        
        function copyToClipboard() {
            const sharePreview = document.getElementById('sharePreview');
            const text = sharePreview.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                    
                    if (tg && tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                    useOldCopyMethod(text);
                });
            } else {
                useOldCopyMethod(text);
            }
        }
        
        function useOldCopyMethod(text) {
            // –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ Clipboard API
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                } else {
                    showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
            }
            
            document.body.removeChild(textarea);
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function generateSharePreview() {
            const sharePreview = document.getElementById('sharePreview');
            const day = currentDate.getDate();
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const dayKey = `${year}-${month}-${day}`;
            const dayData = appData.plan[dayKey] || {};
            
            const monthNamesRu = [
                '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
            ];
            
            let shareText = `üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ ${day} ${monthNamesRu[month]} ${year}\n\n`;
            
            let completedCount = 0;
            let totalCount = appData.habits.length;
            
            appData.habits.forEach(habit => {
                const habitData = dayData[habit.id];
                let status = '‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ';
                
                if (habit.type === 'checkbox' && habitData === true) {
                    status = '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                    completedCount++;
                } else if (habit.type === 'number' && habitData && habitData.value > 0) {
                    status = `‚úÖ ${habitData.value} ${habit.unit}`;
                    completedCount++;
                }
                
                shareText += `${habit.name}: ${status}\n`;
            });
            
            const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            shareText += `\nüìà –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progressPercent}% (${completedCount}/${totalCount})`;
            shareText += `\n\n#–ø—Ä–∏–≤—ã—á–∫–∏ #—Ç—Ä–µ–∫–µ—Ä #–ø—Ä–æ–≥—Ä–µ—Å—Å`;
            
            sharePreview.textContent = shareText;
        }
        
        // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
        
        function initializeStatistics() {
            const statsMonthSelect = document.getElementById('statsMonth');
            const currentYear = new Date().getFullYear();
            
            let optionsHTML = '';
            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(currentYear, i, 1);
                const monthName = monthNames[i];
                const year = monthDate.getFullYear();
                optionsHTML += `<option value="${i}-${year}">${monthName} ${year}</option>`;
            }
            
            const currentMonthIndex = new Date().getMonth();
            statsMonthSelect.innerHTML = optionsHTML;
            statsMonthSelect.value = `${currentMonthIndex}-${currentYear}`;
            
            updateStatisticsChart();
        }
        
        function updateStatisticsChart() {
            const statsMonthSelect = document.getElementById('statsMonth');
            const [selectedMonth, selectedYear] = statsMonthSelect.value.split('-').map(Number);
            
            const monthKey = `${selectedYear}-${selectedMonth}`;
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            
            const dailyProgress = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = `${selectedYear}-${selectedMonth}-${day}`;
                const dayData = appData.plan[dayKey] || {};
                
                let completedCount = 0;
                appData.habits.forEach(habit => {
                    const habitData = dayData[habit.id];
                    if (habit.type === 'checkbox' && habitData === true) {
                        completedCount++;
                    } else if (habit.type === 'number' && habitData && habitData.value > 0) {
                        completedCount++;
                    }
                });
                
                const progressPercent = appData.habits.length > 0 
                    ? Math.round((completedCount / appData.habits.length) * 100) 
                    : 0;
                
                dailyProgress.push({
                    day: day,
                    percent: progressPercent
                });
            }
            
            const hasData = dailyProgress.some(day => day.percent > 0) || appData.habits.length > 0;
            
            if (!hasData) {
                document.getElementById('statsEmpty').style.display = 'block';
                document.getElementById('progressChart').innerHTML = '';
                document.getElementById('statsSummary').innerHTML = '';
                return;
            }
            
            document.getElementById('statsEmpty').style.display = 'none';
            generateProgressChart(dailyProgress, selectedMonth, selectedYear);
            updateStatsSummary(dailyProgress, selectedMonth, selectedYear);
        }
        
        function generateProgressChart(dailyProgress, month, year) {
            const chartContainer = document.getElementById('progressChart');
            const maxValue = 100;
            
            let xAxisHTML = '';
            let barsHTML = '';
            
            const showEvery = Math.max(1, Math.floor(dailyProgress.length / 15));
            
            dailyProgress.forEach((data, index) => {
                const shouldShowLabel = (index % showEvery === 0) || (index === dailyProgress.length - 1);
                xAxisHTML += `<div class="x-label">${shouldShowLabel ? data.day : ''}</div>`;
                
                const barHeight = Math.max(2, (data.percent / maxValue) * 100);
                
                barsHTML += `
                    <div class="bar-container" title="–î–µ–Ω—å ${data.day}: ${data.percent}%">
                        <div class="bar" style="height: ${barHeight}%">
                            <div class="bar-value">${data.percent > 0 ? data.percent + '%' : ''}</div>
                        </div>
                    </div>
                `;
            });
            
            chartContainer.innerHTML = `
                <div class="x-axis">${xAxisHTML}</div>
                <div class="chart-bars">${barsHTML}</div>
            `;
        }
        
        function updateStatsSummary(dailyProgress, month, year) {
            const statsSummary = document.getElementById('statsSummary');
            
            const daysWithProgress = dailyProgress.filter(d => d.percent > 0).length;
            const totalProgress = dailyProgress.reduce((sum, day) => sum + day.percent, 0);
            const averageProgress = dailyProgress.length > 0 ? Math.round(totalProgress / dailyProgress.length) : 0;
            
            const maxDay = dailyProgress.reduce((max, day) => day.percent > max.percent ? day : max, {percent: 0});
            const daysWithData = dailyProgress.filter(d => d.percent > 0);
            const minDay = daysWithData.length > 0 ? 
                daysWithData.reduce((min, day) => day.percent < min.percent ? day : min, {percent: 100}) : 
                {percent: 0, day: 0};
            
            let currentStreak = 0;
            let maxStreak = 0;
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            const todayDay = isCurrentMonth ? today.getDate() : 0;
            
            for (let day = 1; day <= todayDay; day++) {
                const progress = dailyProgress[day - 1]?.percent || 0;
                if (progress > 0) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }
            
            statsSummary.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${averageProgress}%</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${daysWithProgress}</div>
                    <div class="stat-label">–î–Ω–µ–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${maxDay.percent}%</div>
                    <div class="stat-label">–õ—É—á—à–∏–π –¥–µ–Ω—å (${maxDay.day})</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${maxStreak}</div>
                    <div class="stat-label">–ú–∞–∫—Å. —Å–µ—Ä–∏—è</div>
                </div>
            `;
        }
        
        function updateStats() {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ
            const statsElement = document.querySelector('#planner-screen .habits-list');
            if (statsElement && appData.habits.length > 0) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø—Ä–∏–≤—ã—á–µ–∫
                const habitCount = document.querySelector('#planner-screen h2');
                if (habitCount) {
                    habitCount.innerHTML = `–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ <span style="font-size: 14px; color: var(--tg-theme-hint-color);">(${appData.habits.length} –ø—Ä–∏–≤—ã—á–µ–∫)</span>`;
                }
            }
        }
        
        // ========== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ==========
        
        function editHabit(id) {
            const habit = appData.habits.find(h => h.id === id);
            if (!habit) return;
            
            editingHabitId = id;
            document.getElementById('editHabitName').value = habit.name;
            document.getElementById('editHabitUnit').value = habit.unit || '';
            selectEditHabitType(habit.type);
            document.getElementById('editHabitModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editHabitModal').classList.remove('active');
            editingHabitId = null;
        }
        
        function selectEditHabitType(type) {
            editHabitType = type;
            
            const typeBtns = document.querySelectorAll('#editHabitTypeSelector .habit-type-btn');
            typeBtns.forEach(btn => {
                const btnText = btn.textContent || btn.innerText;
                btn.classList.toggle('active', 
                    (btnText.includes('–ß–µ–∫–±–æ–∫—Å') && type === 'checkbox') ||
                    (btnText.includes('–ß–∏—Å–ª–æ–≤–æ–µ') && type === 'number')
                );
            });
            
            const unitInput = document.getElementById('editHabitUnit');
            unitInput.style.display = type === 'number' ? 'block' : 'none';
        }
        
        function saveEditedHabit() {
            if (!editingHabitId) return;
            
            const nameInput = document.getElementById('editHabitName');
            const unitInput = document.getElementById('editHabitUnit');
            const name = nameInput.value.trim();
            const unit = unitInput.value.trim();
            
            if (name === '') {
                showAlertWithHaptic('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏');
                return;
            }
            
            if (editHabitType === 'number' && unit === '') {
                showAlertWithHaptic('–í–≤–µ–¥–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏');
                return;
            }
            
            const habitIndex = appData.habits.findIndex(h => h.id === editingHabitId);
            if (habitIndex !== -1) {
                appData.habits[habitIndex] = {
                    ...appData.habits[habitIndex],
                    name: name,
                    type: editHabitType,
                    unit: editHabitType === 'number' ? unit : null,
                    updated: new Date().toISOString()
                };
                
                renderHabits();
                
                if (isTelegramWebApp) {
                    saveToTelegramCloud();
                } else {
                    saveToLocalStorage();
                }
                
                closeEditModal();
                generateCalendar();
                
                if (document.getElementById('day-screen').classList.contains('active')) {
                    loadToday();
                }
                
                showNotification('‚úÖ –ü—Ä–∏–≤—ã—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            }
        }
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function showCloudBackupModal() {
            document.getElementById('cloudBackupModal').classList.add('active');
            loadBackupList();
        }
        
        function closeCloudModal() {
            document.getElementById('cloudBackupModal').classList.remove('active');
        }
        
        function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...</p>';
            
            // –î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ CloudStorage
            // –≠—Ç–æ —Å–ª–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–º API Telegram
        }
        
        function createNewBackup() {
            createBackup();
            closeCloudModal();
        }
        
        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        window.addEventListener('beforeunload', function(e) {
            if (isTelegramWebApp) {
                saveToTelegramCloud();
            } else {
                saveToLocalStorage();
            }
        });
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        setInterval(() => {
            if (isTelegramWebApp && document.visibilityState === 'visible') {
                saveToTelegramCloud();
            }
        }, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    </script>
</body>
</html>
